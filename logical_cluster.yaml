---
version: '2.0'

Dynamic_OverCloud_Provisioning_LogicalCluster:
  description: Logical_Cluster Workflow
  type: direct

  output:
    vm_id: <% $.vm_id %>

  tasks:
    create_logicalcluster:
      action: nova.servers_create name="logical_cluster" image="8977af23-7831-40aa-89ce-63421e60cbd0" flavor="5a936881-f35c-432f-ae7a-5b4ed8996dc0" key_name="overcloud-1" max_count=1 nic="1a9ba701-79e4-47d9-b740-69b1cb33373c"
      publish:
        vm_id: <% task(create_logicalcluster).result.id %>
      on-success:
#        - search_for_floating_ip
        - wait_instance_active

    search_for_floating_ip:
      description: Gets first free ip from Nova floating IPs.
      action: neutron.list_floatingips status="DOWN"
      publish:
        vm_ip: <% task(search_for_floating_ip).result.floatingips[0].floating_ip_address %>
      on-success:
#        - wait_instance_active
        - associate_ip

    wait_instance_active:
      description: Waits till VM is ACTIVE.
      action: nova.servers_find id=<% $.vm_id %> status="ACTIVE"
      retry:
        count: 10
        delay: 10
      publish:
        status: <% task(wait_instance_active).result.status %>
      on-success:
#        - associate_ip
        - search_for_floating_ip

 
    associate_ip:
      description: Associate server with one of floating IPs.
      action: nova.servers_add_floating_ip server=<% $.vm_id %> address=<% $.vm_ip %>
      on-success:
        - software_download

    software_download:
      action: std.ssh
      retry:
        count: 10
        delay: 10
      input:
        host: <% $.vm_ip %>
        username: "ubuntu"
        private_key_filename: "cloud.key"
        cmd: "git clone http://github.com/smartx-team/box-openstack-installation"

